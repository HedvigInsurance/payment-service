<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Adyen test page</title>
</head>
<body>
<div id="dropin-container"></div>
<script src="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/3.13.0/adyen.js"
        integrity="sha384-cMH19I9HPj31iL3b/lcBcpsqbieCGSLyNef+RzjS7g3h5DhP2BI6j68/ogKSQCAh"
        crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/3.13.0/adyen.css"
      integrity="sha384-AtxcD/Ax9ZRBLJ63s/bwCMrfe/mXWt4TF7F+Vltoxo0WgAwWjVNDsfyMAgY+9nBi"
      crossorigin="anonymous">

<script>

  const paymentMethodsResponse = JSON.parse("{\"paymentMethods\":[{\"brands\":[\"visa\",\"mc\",\"amex\",\"amex_applepay\",\"diners\",\"discover\",\"maestro\",\"mc_applepay\",\"visa_applepay\"],\"details\":[{\"key\":\"encryptedCardNumber\",\"type\":\"cardToken\"},{\"key\":\"encryptedSecurityCode\",\"type\":\"cardToken\"},{\"key\":\"encryptedExpiryMonth\",\"type\":\"cardToken\"},{\"key\":\"encryptedExpiryYear\",\"type\":\"cardToken\"},{\"key\":\"holderName\",\"optional\":true,\"type\":\"text\"}],\"name\":\"Credit Card\",\"type\":\"scheme\"},{\"details\":[{\"key\":\"applepay.token\",\"type\":\"applePayToken\"}],\"name\":\"Apple Pay\",\"supportsRecurring\":true,\"type\":\"applepay\"},{\"details\":[{\"key\":\"paywithgoogle.token\",\"type\":\"payWithGoogleToken\"}],\"name\":\"Google Pay\",\"supportsRecurring\":true,\"type\":\"paywithgoogle\"},{\"name\":\"Trustly\",\"supportsRecurring\":true,\"type\":\"trustly\"},{\"details\":[{\"key\":\"telephoneNumber\",\"optional\":true,\"type\":\"tel\"}],\"name\":\"Vipps\",\"supportsRecurring\":true,\"type\":\"vipps\"}],\"groups\":[{\"name\":\"Credit Card\",\"types\":[\"visa\",\"mc\",\"amex\",\"amex_applepay\",\"diners\",\"discover\",\"maestro\",\"mc_applepay\",\"visa_applepay\"]}]}")

  function showFinalResult(data){
    console.log(data)
    alert(JSON.stringify(data, null, 2))
  }

  function tokenizePayoutDetails(){
    return fetch("/graphql", {
      method: "POST",
      headers: {
        'Content-Type': 'application/json',
        'Hedvig.token': '668328938'
        // 'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: JSON.stringify({
        query:`
        mutation mutation{
          tokenizePayoutDetails(req: {
            channel: WEB
            browserInfo: null
            returnUrl: "http://localhost:8081/index.html"
            paymentMethodDetails: "{\\"type\\": \\"trustly\\"}"
          }){
            ... on TokenizationResponseFinished {resultCode}
            ... on TokenizationResponseAction { action }
          }
        }
        `
      })
    }).then(res => res.json())
    .then(res => res.data.tokenizePayoutDetails)
  }

  function makeDetailsCall(details){
    return fetch("/graphql", {
      method: "POST",
      headers: {
        'Content-Type': 'application/json',
        'Hedvig.token': '668328938'
        // 'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: JSON.stringify({
        query:`
        mutation SubmitAdditionalPaymentDetails($details: PaymentsDetailsRequest!){
          submitAdditionalPaymentDetails(req: {
            paymentsDetailsRequest: $details
          }) {
            ... on AdditionalPaymentsDetailsResponseAction {
              action
            }
            ... on AdditionalPaymentsDetailsResponseFinished {
              resultCode
            }
          }
        }
        `,
        variables: {
          "details": JSON.stringify(details)
        }
      })
    }).then(res => res.json())
      .then(res => res.data)
  }

  const configuration = {
    paymentMethodsResponse: paymentMethodsResponse, // The `/paymentMethods` response from the server.
    clientKey: "{{clientKey}}",
    locale: "en-US",
    environment: "test",
    onSubmit: (state, dropin) => {
      // Your function calling your server to make the `/payments` request
      localStorage.removeItem("paymentData")

      tokenizePayoutDetails()
        .then(response => {
          if (response.action) {
            // Drop-in handles the action object from the /payments response
            const action = JSON.parse(response.action)

            localStorage.setItem("paymentData", action.paymentData)

            dropin.handleAction(action);
          } else {
            // Your function to show the final result to the shopper
            showFinalResult(response);
          }
        })
        .catch(error => {
          throw Error(error);
        });
    },
    onAdditionalDetails: (state, dropin) => {
      // Your function calling your server to make a `/payments/details` request
      // TODO: check if `state.data` matches our expected format
      makeDetailsCall(state.data)
        .then(response => {
          if (response.action) {
            // Drop-in handles the action object from the /payments response
            dropin.handleAction(response.action);
          } else {
            // Your function to show the final result to the shopper
            showFinalResult(response);
          }
        })
        .catch(error => {
          throw Error(error);
        });
    },
    paymentMethodsConfiguration: {
      card: { // Example optional configuration for Cards
        hasHolderName: true,
        holderNameRequired: true,
        enableStoreDetails: true,
        hideCVC: false, // Change this to true to hide the CVC field for stored cards
        name: 'Credit or debit card'
      }
    }
  };

  const checkout = new AdyenCheckout(configuration);

  const dropin = checkout.create('dropin').mount('#dropin-container');

  const payload = (new URL(document.location)).searchParams.get("payload")
  const paymentData = localStorage.getItem("paymentData")
  if (payload !== null && paymentData !== null) {
    const obj = {
      paymentData: paymentData,
      details: {
        payload: payload
      }
    }

    makeDetailsCall(obj)
      .then(res => {
        showFinalResult(res);
      })
  }
</script>



</body>
</html>
